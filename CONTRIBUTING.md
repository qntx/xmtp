# Contributing to qntx/xmtp

## Architecture Overview

```text
┌─────────────────────────────────────────────────────────┐
│                    Cargo Workspace                      │
│                                                         │
│  xmtp-sys/     Raw FFI bindings (auto-generated)        │
│  xmtp/         Safe high-level Rust SDK                 │
│  xmtp-cli/     TUI chat client                          │
│                                                         │
│  xmtp-ffi/     Standalone — C FFI wrapper (excluded)    │
└─────────────────────────────────────────────────────────┘
```

### Crate Dependency Graph

```text
libxmtp (upstream)
    ↓ git dependency (pinned rev)
xmtp-ffi/          C FFI wrapper, staticlib/cdylib
    ↓ cbindgen (build.rs)
xmtp-ffi/include/xmtp_ffi.h
    ↓ GitHub Release (libxmtp_ffi.a + xmtp_ffi.h)
xmtp-sys/          Raw Rust bindings via bindgen
    ↓
xmtp/              Safe SDK (Client, Conversation, Stream, …)
    ↓
xmtp-cli/          TUI binary
```

### Workspace Layout

| Path | Description |
| --- | --- |
| `xmtp-sys/` | `-sys` crate — raw FFI bindings to `libxmtp_ffi.a`. Auto-generated by `bindgen`. |
| `xmtp/` | High-level safe SDK. Wraps `xmtp-sys` with RAII handles, error types, and idiomatic Rust API. |
| `xmtp-cli/` | TUI chat client built on `xmtp/`. Thread model: main (UI) + worker (FFI) + poller (input). |
| `xmtp-ffi/` | **Standalone crate** (excluded from workspace). Wraps upstream `libxmtp` crates into a flat C API. Has its own `Cargo.toml`, `rust-toolchain.toml` (nightly), and dependency tree. |
| `3rdparty/` | Vendored upstream sources (`libxmtp`, `xmtp-js`) for reference. Not built by the workspace. |

## FFI Binding Pipeline

This is the most important build pipeline to understand. Getting it wrong causes ABI mismatches at runtime.

### Step 1: Build the FFI static library (`xmtp-ffi`)

```text
xmtp-ffi/src/*.rs  ──cargo build──→  libxmtp_ffi.a / xmtp_ffi.lib
                   ──cbindgen────→  xmtp-ffi/include/xmtp_ffi.h
```

- `cbindgen` runs in `xmtp-ffi/build.rs` and generates the C header from Rust source.
- Configuration: `xmtp-ffi/cbindgen.toml` (C language, `Xmtp` prefix, `ScreamingSnakeCase` enums).
- The FFI crate is a **standalone workspace** — it depends on upstream `libxmtp` crates via git (pinned to a specific commit in `Cargo.toml`).
- CI builds for all targets via `.github/workflows/ffi-build.yml`, triggered by `ffi-v*.*.*` tags.

### Step 2: Generate Rust bindings (`xmtp-sys`)

```text
xmtp_ffi.h  ──bindgen──→  xmtp-sys/src/bindings.rs  (committed)
```

- `bindgen` runs in `xmtp-sys/build.rs` only when the `regenerate` feature is enabled.
- Without `regenerate`, pre-committed `src/bindings.rs` is used directly.
- The `preprocess_header()` function cleans up cbindgen quirks before feeding to bindgen (e.g., stripping duplicate `typedef int32_t` lines for enums).
- At build time, the build script downloads `libxmtp_ffi.a` from GitHub Releases (or uses `XMTP_FFI_DIR` for local dev).

### Step 3: Regenerating bindings

```sh
# Unix
XMTP_FFI_DIR=../xmtp-ffi XMTP_UPDATE_BINDINGS=1 cargo check -p xmtp-sys --features regenerate

# Or via Makefile
make regenerate-bindings
```

This will:

1. Read `xmtp-ffi/include/xmtp_ffi.h`
2. Preprocess it (strip conflicting typedefs)
3. Run `bindgen` → `$OUT_DIR/bindings.rs`
4. Copy the result to `xmtp-sys/src/bindings.rs` (for committing)

**Important**: Never hand-edit `xmtp-sys/src/bindings.rs`. Always regenerate through the pipeline.

### Known cbindgen Limitation

cbindgen cannot represent `Option<TypeAlias>` where `TypeAlias` is a function pointer type alias.
It emits an opaque forward declaration instead of a nullable function pointer.

**Rule**: In `xmtp-ffi` extern "C" function signatures, always use **inline** `Option<unsafe extern "C" fn(...)>`, never `Option<FnMyCallback>`. Type aliases are fine for internal Rust code, but must be inlined at the FFI boundary.

## Development Setup

### Prerequisites

- Rust stable toolchain (see `rust-toolchain.toml`)
- Rust nightly toolchain (for `clippy`, `fmt`, and `xmtp-ffi` builds)
- `libclang` (for `bindgen` — only needed when regenerating bindings)

### Environment Variables

| Variable | Purpose |
| --- | --- |
| `XMTP_FFI_DIR` | Path to local `xmtp-ffi/` crate root. Skips downloading from GitHub Releases. |
| `XMTP_FFI_VERSION` | Override FFI release version to download. Defaults to crate version. |
| `XMTP_UPDATE_BINDINGS` | When set with `regenerate` feature, copies generated bindings to `src/bindings.rs`. |

### Common Commands

```sh
make check          # cargo check --all-features
make build          # cargo build --release --all-features
make test           # cargo test --all-features
make clippy         # clippy with auto-fix (nightly)
make fmt            # rustfmt (nightly)
make ffi-build      # build xmtp-ffi static library
make ffi-check      # check xmtp-ffi compilation
make regenerate-bindings  # regenerate xmtp-sys/src/bindings.rs
make pre-commit     # fmt + clippy + test + build + changelog
```

## Code Style

- **Edition**: Rust 2024
- **Lints**: Strict — `clippy::pedantic` with targeted allowances (see `Cargo.toml` `[workspace.lints]`)
- **Comments**: English only, professional
- **Formatting**: `rustfmt` with nightly features (see `rustfmt.toml`)
- **No `unsafe` outside `xmtp-sys` and `xmtp/src/ffi.rs` / `xmtp/src/stream.rs`**

### FFI Conventions (xmtp-ffi)

- Every public function returns `i32` (0 = ok, -1 = error) unless returning a primitive.
- Errors stored in thread-local string, retrieved via `xmtp_last_error_message()`.
- Opaque handles are heap-allocated (`Box::into_raw`) with explicit `_free` functions.
- Async operations block on a shared global tokio runtime.
- Callbacks use C function pointers with a `void *context` for user data.

### SDK Conventions (xmtp)

- RAII `OwnedHandle<T>` wraps every FFI pointer — calls `free` on drop.
- `error::check(rc)` converts FFI return codes to `Result`.
- `ffi::take_c_string()` takes ownership of C strings and frees them.
- All FFI calls are in `ffi.rs`, `stream.rs`, `client/`, or `conversation.rs` — no raw FFI elsewhere.

### CLI Conventions (xmtp-cli)

- **Main thread**: Pure UI — render + event dispatch. Zero FFI calls, zero blocking.
- **Worker thread**: Owns `Client`, handles all FFI/network operations via `Cmd` channel.
- **Poller thread**: `crossterm` input polling + tick timer.
- Communication: `Event` (worker→UI), `Cmd` (UI→worker).

## CI/CD

| Workflow | Trigger | Purpose |
| --- | --- | --- |
| `rust.yml` | Push/PR to `main` | CI checks (reusable workflow) |
| `ffi-build.yml` | `ffi-v*.*.*` tag | Build FFI static libraries for all targets |
| `cd.yml` | `v*.*.*` tag | Build CLI binaries, create GitHub Release |
| `rust-publish.yml` | `v*.*.*` tag | Publish `xmtp` and `xmtp-cli` to crates.io |

### Release Flow

1. Update upstream libxmtp pin in `xmtp-ffi/Cargo.toml` if needed
2. `git tag ffi-v0.1.x && git push --tags` → builds + releases FFI artifacts
3. Bump `xmtp-sys` version to match → downloads new FFI from release
4. `make regenerate-bindings` if header changed
5. `git tag v0.4.x && git push --tags` → builds CLI binaries + publishes crates

## Supported Platforms

| Target | CLI | FFI |
| --- | --- | --- |
| `x86_64-unknown-linux-gnu` | ✅ | ✅ |
| `aarch64-unknown-linux-gnu` | ✅ | ✅ |
| `aarch64-apple-darwin` | ✅ | ✅ |
| `x86_64-pc-windows-msvc` | ✅ | ✅ |
| `aarch64-pc-windows-msvc` | ✅ | ✅ |
